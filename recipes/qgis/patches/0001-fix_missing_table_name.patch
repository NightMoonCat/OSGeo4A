From ff13e5b546bab9e2f7f949f3aba7a29d53379dd5 Mon Sep 17 00:00:00 2001
From: Denis Rouzaud <denis.rouzaud@gmail.com>
Date: Tue, 9 Jun 2020 10:47:44 +0200
Subject: [PATCH] fix missing table name

this was causing a crash
---
 src/core/qgssqliteutils.cpp | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/core/qgssqliteutils.cpp b/src/core/qgssqliteutils.cpp
index 96db18daee78..a1c94ddd4048 100644
--- a/src/core/qgssqliteutils.cpp
+++ b/src/core/qgssqliteutils.cpp
@@ -126,7 +126,9 @@ QSet<QString> QgsSqliteUtils::uniqueFields( sqlite3 *connection, const QString &
   QSet<QString> uniqueFieldsResults;
   char *zErrMsg = 0;
   std::vector<std::string> rows;
-  QString sql = QgsSqlite3Mprintf( "select sql from sqlite_master where type='table' and name=%q", quotedIdentifier( tableName ).toStdString().c_str() );
+  QByteArray tableNameUtf8 = quotedIdentifier( tableName ).toUtf8();
+  QString sql = QgsSqlite3Mprintf( "select sql from sqlite_master "
+                                   "where type='table' and name=%q", tableNameUtf8.constData() );
   auto cb = [ ](
               void *data /* Data provided in the 4th argument of sqlite3_exec() */,
               int /* The number of columns in row */,
@@ -172,7 +174,7 @@ QSet<QString> QgsSqliteUtils::uniqueFields( sqlite3 *connection, const QString &
 
   // Search indexes:
   sql = QgsSqlite3Mprintf( "SELECT sql FROM sqlite_master WHERE type='index' AND"
-                           " tbl_name='%q' AND sql LIKE 'CREATE UNIQUE INDEX%%'" );
+                           " tbl_name='%q' AND sql LIKE 'CREATE UNIQUE INDEX%%'", tableNameUtf8.constData() );
   rc = sqlite3_exec( connection, sql.toUtf8(), cb, ( void * )&rows, &zErrMsg );
   if ( rc != SQLITE_OK )
   {
